<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ | VORTEX POS</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–∞—Ç–µ–≥–æ—Ä–∏–π</h1>
        <nav>
            <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/products">–¢–æ–≤–∞—Ä—ã</a>
            <a href="/admin/products/new">–î–æ–±–∞–≤–∏—Ç—å –¢–æ–≤–∞—Ä</a>
        </nav>
    </header>

    <main class="container">
        
        <section class="card">
            <h2>–°–æ–∑–¥–∞—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
            <form id="category-form">

                <label for="parent-id">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–æ–ø—Ü.):</label>
                <select id="parent-id">
                    <option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è) --</option>
                    </select>
                
                <input type="hidden" id="category-id" value="">
                
                <label for="category-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                <input type="text" id="category-name" required>
                
                <button type="submit" id="submit-button">–°–æ–∑–¥–∞—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é</button>
            </form>
        </section>

        <section class="card mt-3">
            <h2>–°–ø–∏—Å–æ–∫ –ö–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
            <ul id="category-list" class="list-group">
                </ul>
        </section>

    </main>

    <script>
        const API_URL = '/api/categories/';
        const form = document.getElementById('category-form');
        const nameInput = document.getElementById('category-name');
        const idInput = document.getElementById('category-id');
        const submitButton = document.getElementById('submit-button');
        const categoryList = document.getElementById('category-list');
        const parentIdSelect = document.getElementById('parent-id');

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–µ—Ä–µ–≤–∞
        function renderCategoryTree(categories, parentElement, depth = 0) {
            categories.forEach(category => {
                const listItem = document.createElement('li');
                const padding = depth * 20; // –û—Ç—Å—Ç—É–ø –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
                listItem.className = 'list-item';
                listItem.style.paddingLeft = `${padding}px`;
        
                listItem.innerHTML = `
                    <span>${'‚Äî'.repeat(depth)} ${category.name} (ID: ${category.id})</span>
                    <div>
                        <button onclick="editCategory(${category.id}, '${category.name}', ${category.parent_id || null})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="deleteCategory(${category.id})" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                parentElement.appendChild(listItem);
                
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (category.children && category.children.length > 0) {
                    renderCategoryTree(category.children, parentElement, depth + 1);
                }
            });
        }
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        function fillSelectOptions(categories, parentSelect, prefix = "") {
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = prefix + category.name;
                parentSelect.appendChild(option);
                
                if (category.children && category.children.length > 0) {
                    // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–µ—Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "--")
                    fillSelectOptions(category.children, parentSelect, prefix + "‚Äî ");
                }
            });
        }
        
        // 1. –ó–ê–ì–†–£–ó–ö–ê –ò –†–ï–ù–î–ï–†–ò–ù–ì –ö–ê–¢–ï–ì–û–†–ò–ô
        async function fetchAndRenderCategories() {
            categoryList.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            // –û—á–∏—â–∞–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ü–∏—é "–ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è"
            parentIdSelect.innerHTML = '<option value="">-- –ù–µ—Ç (–ö–æ—Ä–Ω–µ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è) --</option>'; 
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
                const categories = await response.json();
                
                categoryList.innerHTML = '';
                renderCategoryTree(categories, categoryList); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ
                fillSelectOptions(categories, parentIdSelect); // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        
            } catch (error) {
                categoryList.innerHTML = `<li class="error">${error.message}</li>`;
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // 2. –°–û–ó–î–ê–ù–ò–ï –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò (–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const id = idInput.value;
            // üí• –ù–û–í–û–ï: –ø–æ–ª—É—á–∞–µ–º ID —Ä–æ–¥–∏—Ç–µ–ª—è üí•
            const parent_id = parentIdSelect.value ? parseInt(parentIdSelect.value) : null; 
            
            if (!name) return;
        
            const isEditing = id !== '';
            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `${API_URL}${id}` : API_URL;
        
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    // üí• –ù–û–í–û–ï: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º parent_id üí•
                    body: JSON.stringify({ name: name, parent_id: parent_id }) 
                });
        
                // ... (–æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞) ...
                
            } catch (error) {
                // ...
            }
        });

        // 3. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –§–û–†–ú–´ –í –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        function editCategory(id, name, parent_id) {
            idInput.value = id;
            nameInput.value = name;
            // üí• –ù–û–í–û–ï: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è üí•
            parentIdSelect.value = parent_id || ''; 
            submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è';
        }

        // 4. –°–ë–†–û–° –§–û–†–ú–´
        function resetForm() {
            idInput.value = '';
            nameInput.value = '';
            submitButton.textContent = '–°–æ–∑–¥–∞—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é';
        }

        

        // 5. –£–î–ê–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò
        async function deleteCategory(id) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ID ${id}?`)) return;

            try {
                const response = await fetch(`${API_URL}${id}`, {
                    method: 'DELETE'
                });

                if (response.status === 204) {
                    alert(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ID ${id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!`);
                    fetchAndRenderCategories();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ ${response.status}: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é.`);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = fetchAndRenderCategories;
    </script>
</body>
</html>
